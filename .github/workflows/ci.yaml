name: ci

on:
  push:
    paths:
      - src/**
    branches:
      - main

permissions:
  contents: read

jobs:
  docker:
    runs-on: ubuntu-latest
    outputs:
      commit_id: ${{ steps.vars.outputs.commit_id }}
    steps:
      -
        name: Set commit id
        id: vars
        shell: bash
        run: echo "commit_id=${GITHUB_SHA::6}" >> "$GITHUB_OUTPUT"
      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: kittyiv/python-app-jeff:${{ steps.vars.outputs.commit_id }}

  cd:
    needs: docker
    runs-on:
      - self-hosted
      - linux
      - x64
      - python-app-jeff
    steps:

      - uses: actions/checkout@v4

      - name: Configure kubeconfig from in-cluster service account
        shell: bash
        run: |
          if [ -z "${KUBERNETES_SERVICE_HOST:-}" ]; then
            echo "KUBERNETES_SERVICE_HOST is missing. Runner must run inside Kubernetes." >&2
            exit 1
          fi
          cat > "$RUNNER_TEMP/kubeconfig" <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - name: in-cluster
            cluster:
              server: https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS:-443}
              certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          users:
          - name: runner
            user:
              tokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
          contexts:
          - name: in-cluster
            context:
              cluster: in-cluster
              user: runner
          current-context: in-cluster
          EOF
          echo "KUBECONFIG=$RUNNER_TEMP/kubeconfig" >> "$GITHUB_ENV"

      - name: Install Helm
        shell: bash
        run: |
          HELM_VERSION="v3.16.4"
          HELM_TGZ="$RUNNER_TEMP/helm.tar.gz"
          curl -fsSL -o "$HELM_TGZ" "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz"
          tar -xzf "$HELM_TGZ" -C "$RUNNER_TEMP"
          mv "$RUNNER_TEMP/linux-amd64/helm" "$RUNNER_TEMP/helm"
          chmod +x "$RUNNER_TEMP/helm"
          echo "$RUNNER_TEMP" >> "$GITHUB_PATH"

      - name: Deploy with Helm
        shell: bash
        run: |
          helm upgrade --install python-app ./charts/python-app \
            --namespace python \
            --create-namespace \
            --set image.repository=kittyiv/python-app-jeff \
            --set-string image.tag=${{ needs.docker.outputs.commit_id }} \
            --wait \
            --timeout 5m
